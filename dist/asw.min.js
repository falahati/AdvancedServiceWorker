var __extends,AdvancedServiceWorker;(function(n){var t=function(){function n(t){this.url=null;this.header=null;Object.assign(this,t||{});this.url&&(typeof this.url=="string"||this.url instanceof String)&&(this.url=n.wildCardToRegEx(this.url));this.header&&(typeof this.header=="string"||this.header instanceof String)&&(this.header=n.wildCardToRegEx(this.header))}return n.getRelativeUrl=function(n){return(n.indexOf("http://")===0||n.indexOf("https://")===0)&&n.indexOf("/",8)!==-1&&(n=n.substr(n.indexOf("/",8))),n},n.prototype.doesMatch=function(t){var r,i,u,f,e;if(this.url&&(!t.url||!this.url.test(n.getRelativeUrl(t.url))))return!1;if(this.header){if(!t.headers)return!1;for(r=!1,i=0,u=t.headers.entries();i<u.length;i++)if(f=u[i],e=f[0]+": "+f[1],this.header.test(e)){r=!0;break}if(!r)return!1}return!0},n.wildCardToRegEx=function(n){return new RegExp("^"+n.split("*").join(".*")+"$")},n}();n.Condition=t})(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t;(function(n){n.Disable="DISABLE";n.CacheFirst="CACHE_FIRST";n.NetworkFirst="NETWORK_FIRST";n.CacheOnly="CACHE_ONLY";n.NetworkOnly="NETWORK_ONLY";n.Race="RACE"})(t=n.Strategies||(n.Strategies={}))}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t=function(){function t(t){this.conditions=[];this.strategy=n.Strategies.Disable;this.offline=null;this.networkTimeout=3e3;Object.assign(this,t||{});for(var i=0;i<this.conditions.length;i++)this.conditions[i]=new n.Condition(this.conditions[i])}return t.prototype.doesMatch=function(n){for(var t=0;t<this.conditions.length;t++)if(this.conditions[t].doesMatch(n))return!0;return!1},t}();n.Rule=t}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t=function(){function t(t){this.version=0;this.storageName="offline-cache";this.preload=[];this.scope="/";this.filePath="/asw.js";this.persistent=!1;this.pushServerAddress="";this.pushServerKey=null;this.pushUserVisibleOnly=!0;this.debug=!1;this.rules=[];Object.assign(this,t||{});for(var i=0;i<this.rules.length;i++)this.rules[i].offline&&this.preload.indexOf(this.rules[i].offline)===-1&&this.preload.push(this.rules[i].offline),this.rules[i]=new n.Rule(this.rules[i])}return t}();n.Options=t}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t;(function(n){n.Notification="NOTIFICATION";n.ClearCache="CLEAECACHE";n.Preload="PRELOAD";n.Reload="RELOAD";n.Broadcast="BROADCAST"})(t=n.ActionTypes||(n.ActionTypes={}))}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t=function(){function n(n){this.actionType=n}return n}();n.Action=t}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t=function(){function n(n,t){this.scope=n;this.data=typeof t=="undefined"?null:t}return n.prototype.equal=function(n){return this.scope===n.scope&&JSON.stringify(this)===JSON.stringify(n)},n}();n.Message=t}(AdvancedServiceWorker||(AdvancedServiceWorker={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(n){function t(t,i){return n.call(this,t,i)||this}return __extends(t,n),t}(n.Message);n.RequestMessage=t}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t=function(n){function t(t,i,r){var u=n.call(this,t,r)||this;return u.request=i,u}return __extends(t,n),t}(n.Message);n.ResponseMessage=t}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t;(function(t){var i=function(t){function i(i){var r=t.call(this,n.ActionTypes.Broadcast)||this;return r.message=i,r}return __extends(i,t),i}(n.Action);t.Broadcast=i})(t=n.Actions||(n.Actions={}))}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t;(function(t){var i=function(t){function i(i){var r=t.call(this,n.ActionTypes.ClearCache)||this;return r.condition=i||null,r}return __extends(i,t),i}(n.Action);t.ClearCache=i})(t=n.Actions||(n.Actions={}))}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t;(function(t){var i=function(t){function i(i,r,u){var f=t.call(this,n.ActionTypes.Notification)||this;return f.title=i,f.options=r||{},f.options.data=Object.assign(f.options.data||{},{url:u}),f}return __extends(i,t),i}(n.Action);t.Notification=i})(t=n.Actions||(n.Actions={}))}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t;(function(t){var i=function(t){function i(i){var r=t.call(this,n.ActionTypes.Preload)||this;return r.urls=i,r}return __extends(i,t),i}(n.Action);t.Preload=i})(t=n.Actions||(n.Actions={}))}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t=function(){function t(){}return t.getIdb=function(n,t){var i=this;return new Promise(function(n,t){var r=indexedDB.open(i.databaseName,1);r.onerror=function(){return t(r.error)};r.onsuccess=function(){return n(r.result)};r.onupgradeneeded=function(){r.result.createObjectStore(i.storeName)}}).then(function(r){return new Promise(function(u,f){var e=r.transaction(i.storeName,n);e.oncomplete=function(){return u()};e.onabort=e.onerror=function(){return f(e.error)};t(e.objectStore(i.storeName))})})},t.saveOptions=function(i){var r=n.Condition.getRelativeUrl(i.scope);return t.getIdb("readwrite",function(n){n.put(i,r)}).then(function(){return!0},function(n){return console.log(n),!1})},t.loadOptions=function(i){i=n.Condition.getRelativeUrl(i);var r;return t.getIdb("readonly",function(n){r=n.get(i)}).then(function(){return r.result},function(){return null})},t.databaseName="advanced-service-worker",t.storeName="keyval",t}();n.BrowserDatabase=t}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t=function(){function t(n,t){t&&(n+="-v"+t);this.storageName=n}return t.prototype.open=function(){return caches.open(this.storageName)},t.prototype.remove=function(t){return t?typeof t=="string"||t instanceof String||t instanceof RegExp?(t instanceof RegExp||(t=n.Condition.wildCardToRegEx(t)),this.open().then(function(n){return n.keys().then(function(i){var r=[];return(i.forEach(function(i){i.url&&t.test(i.url)&&r.push(n.delete(i))}),!r.length)?Promise.resolve(!1):Promise.all(r).then(function(n){for(var t=0;t<n.length;t++)if(n[t])return!0;return!1},function(){return!1})})})):t instanceof Array&&t.length?this.open().then(function(n){for(var r=[],i=0;i<t.length;i++)r.push(n.delete(t[i]));return Promise.all(r).then(function(n){for(var t=0;t<n.length;t++)if(n[t])return!0;return!1},function(){return!1})}):Promise.resolve(!1):caches.delete(this.storageName)},t.prototype.preloadUrls=function(n){return n?this.open().then(function(t){return t.addAll(n).then(function(){return!0},function(){return console.error("Failed to add preload pages to cache."),!1})},function(){return console.error("Failed to open cache."),!1}):Promise.resolve(!1)},t.prototype.putResponse=function(n,t){if(!t)throw new Error("Can not add an empty response to cache.");return t.status!==200&&t.status!==204&&t.status!==300&&t.status!==301&&t.status!==303&&t.status!==308?Promise.resolve():this.open().then(function(i){return i.put(n,t)})},t.prototype.getResponse=function(n){return this.open().then(function(t){return t.match(n).then(function(n){if(n)return n;throw new Error("Cache contains empty response.");})})},t}();n.BrowserCache=t}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t=function(){function t(i){var r=this;this.options=new n.Options(i);this.eventElement=document.createElement("eventElement");t.addGlobalEventListener("message",function(n){var t=n.detail.data;t.scope===r.options.scope&&r.eventElement.dispatchEvent(new CustomEvent("message",{detail:t.data}))})}return t.addGlobalEventListener=function(n,i,r){t.staticEventElement.addEventListener(n,i,r)},t.prototype.addEventListener=function(n,t,i){this.eventElement.addEventListener(n,t,i)},t.prototype.postMessage=function(i){var r=this;return new Promise(function(u,f){t.isInstalled()||f(new Error("Service worker is not installed."));var e=new n.RequestMessage(r.options.scope,i),o=new MessageChannel;o.port1.onmessage=function(n){var t=n.data;t.scope===r.options.scope&&t.request&&e.equal(t.request)&&u(t.data)};self.navigator.serviceWorker.controller.postMessage(e,[o.port2]);setTimeout(function(){f(new Error("Response timeout."))},100)})},t.prototype.showNotification=function(t,i,r){return this.postMessage(new n.Actions.Notification(t,i,r))},t.prototype.reload=function(){return this.postMessage(new n.Action(n.ActionTypes.Reload))},t.prototype.clearCache=function(t){return this.postMessage(new n.Actions.ClearCache(t))},t.prototype.preload=function(t){return this.postMessage(new n.Actions.Preload(t))},t.prototype.broadcast=function(t){return this.postMessage(new n.Actions.Broadcast(t))},t.prototype.ensureInstalled=function(){var i=this,r;return t.isSupported()?(r=this.options.filePath,this.options.version&&(r=r+"?v="+this.options.version),n.BrowserDatabase.loadOptions(this.options.scope).then(function(t){var u=!!self.navigator.serviceWorker.controller,f=u&&(!t||JSON.stringify(t)!==JSON.stringify(i.options));if(u&&!f)console.debug("Active service worker found, no need to register.");else return n.BrowserDatabase.saveOptions(i.options).then(function(){return navigator.serviceWorker.register(r,{scope:i.options.scope}).then(function(n){return(console.info("Service worker has been registered for scope: "+n.scope),f)?n.update().then(function(){return i.reload(),console.info("Service worker has been updated."),!0}):!0})}).catch(function(){return console.error("Failed to register or update the service worker."),!1});return!1})):(console.error("Service workers are not supported."),Promise.resolve(!1))},t.isSupported=function(){return"serviceWorker"in self.navigator&&"storage"in self.navigator},t.isInstalled=function(){return t.isSupported&&!!self.navigator.serviceWorker.controller},t.staticConstructor=function(){t.isSupported&&"document"in self&&(t.staticEventElement=document.createElement("eventElement"),self.navigator.serviceWorker.addEventListener("message",function(n){t.staticEventElement.dispatchEvent(new CustomEvent("message",{detail:n}))}),self.navigator.serviceWorker.addEventListener("controllerchange",function(n){t.staticEventElement.dispatchEvent(new CustomEvent("controllerchange",{detail:n}))}),self.navigator.serviceWorker.addEventListener("messageerror",function(n){t.staticEventElement.dispatchEvent(new CustomEvent("messageerror",{detail:n}))}))}(),t}();n.Controller=t}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t=function(){function t(n,t,i){this.messages=[];this.response=null;this.request=n;this.rule=t;this.cache=i}return t.prototype.message=function(n){this.messages.push(n)},t.prototype.wasSuccessful=function(){return!!this.response},t.prototype.end=function(n,t){return this.message(n),this.wasSuccessful()||(this.response=t||null,this.message("End of operation.")),this.response},t.prototype.fatal=function(n){var t=new Error(n);return this.message("Operation failed. "+t),this.message("Trying native fetch as the last resort."),this.response=null,fetch(this.request)},t.prototype.getResponse=function(){switch(this.rule.strategy){case n.Strategies.NetworkFirst:return this.strategyNetworkFirst();case n.Strategies.CacheFirst:return this.strategyCacheFirst();case n.Strategies.NetworkOnly:return this.strategyNetworkOnly();case n.Strategies.CacheOnly:return this.strategyCacheOnly();case n.Strategies.Race:return this.strategyRace();case n.Strategies.Disable:return this.end("Disabled"),null}return null},t.prototype.strategyNetworkFirst=function(){var n=this;return this.getLive(this.request).then(function(t){return n.message("Fetched from network."),n.cache.putResponse(n.request,t.clone()).then(function(){return n.end("Saved to cache.",t)},function(i){return n.end("Failed to save to cache. "+i.toString(),t)})},function(t){return n.message("Network failed, switching to cache. "+t.toString()),n.cache.getResponse(n.request).then(function(t){return n.end("Fetched from cache.",t)},function(t){return(n.message("Cache failed, switching to offline page. "+t.toString()),!n.rule.offline)?n.fatal("Missing offline page."):n.cache.getResponse(n.rule.offline).then(function(t){return n.end("Offline page served.",t)},function(t){return n.fatal("Cache failed for offline page. "+t.toString())})})})},t.prototype.strategyCacheFirst=function(){var n=this;return this.cache.getResponse(this.request).then(function(t){return n.end("Fetched from cache.",t)},function(t){return n.message("Cache failed, switching to network. "+t.toString()),n.getLive(n.request).then(function(t){return n.message("Fetched from network."),n.cache.putResponse(n.request,t.clone()).then(function(){return n.end("Saved to cache.",t)},function(i){return n.end("Failed to save to cache. "+i.toString(),t)})},function(t){return(n.message("Network failed, switching to offline page. "+t.toString()),!n.rule.offline)?n.fatal("Missing offline page."):n.cache.getResponse(n.rule.offline).then(function(t){return n.end("Offline page served.",t)},function(t){return n.fatal("Cache failed for offline page. "+t.toString())})})})},t.prototype.strategyNetworkOnly=function(){var n=this;return this.getLive(this.request).then(function(t){return n.end("Fetched from network.",t)},function(t){return(n.message("Network failed, switching to offline page. "+t.toString()),!n.rule.offline)?n.fatal("Missing offline page."):n.cache.getResponse(n.rule.offline).then(function(t){return n.end("Offline page served.",t)},function(t){return n.fatal("Cache failed for offline page. "+t.toString())})})},t.prototype.strategyCacheOnly=function(){var n=this;return this.cache.getResponse(this.request).then(function(t){return n.end("Fetched from cache.",t)},function(t){return(n.message("Cache failed, switching to offline page. "+t.toString()),!n.rule.offline)?n.fatal("Missing offline page."):n.cache.getResponse(n.rule.offline).then(function(t){return n.end("Offline page served.",t)},function(t){return n.fatal("Cache failed for offline page. "+t.toString())})}).catch(function(){return fetch(n.request)})},t.prototype.strategyRace=function(){var n=this,t=this.getLive(this.request).then(function(t){return n.message("Fetched from network."),n.cache.putResponse(n.request,t.clone()).then(function(){return n.end("Saved to cache.",t)},function(i){return n.end("Failed to save to cache. "+i.toString(),t)})}),i=this.rule.networkTimeout<=0?Promise.resolve({}):new Promise(function(t){setTimeout(function(){n.message("Network delay reached, trying cache...");t()},n.rule.networkTimeout)});return new Promise(function(r,u){var f=0;t.then(r,function(t){f++;f>=2?u(t):n.cache.getResponse(n.request).then(function(t){return r(n.end("Fetched from cache.",t))},u)});i.then(function(){return n.cache.getResponse(n.request).then(function(t){return r(n.end("Fetched from cache.",t))},function(n){f++;f>=2&&u(n)})})}).catch(function(t){return(n.message("Race failed, switching to offline page. "+t.toString()),!n.rule.offline)?n.fatal("Missing offline page."):n.cache.getResponse(n.rule.offline).then(function(t){return n.end("Offline page served.",t)},function(t){return n.fatal("Cache failed for offline page. "+t.toString())})})},t.prototype.getLive=function(n){return fetch(n).then(function(n){if(!n)throw new Error("Network is not accessible.");if(n.status===408||n.status===500||n.status===502||n.status===503||n.status===504)throw new Error("Bad network response.");return n})},t}();n.FetchRequest=t}(AdvancedServiceWorker||(AdvancedServiceWorker={})),function(n){var t=function(){function t(){this.cachedOptions=null;self.addEventListener("activate",this.onActivate.bind(this));self.addEventListener("install",this.onInstall.bind(this));self.addEventListener("fetch",this.onFetch.bind(this));self.addEventListener("sync",this.onSync.bind(this));self.addEventListener("pushsubscriptionchange",this.onPushSubscriptionChange.bind(this));self.addEventListener("notificationclick",this.onNotificationClick.bind(this));self.addEventListener("push",this.onPush.bind(this));self.addEventListener("message",this.onMessage.bind(this))}return t.prototype.onInstall=function(n){this.debug("Processing install event...",n);n.waitUntil(self.skipWaiting().then(this.reload.bind(this)))},t.prototype.onActivate=function(n){this.debug("Processing activate event...",n);n.waitUntil(this.getOptions().then(function(){self.clients.claim()}))},t.prototype.onFetch=function(t){var r=this,i,u;t.request&&t.request.method==="GET"&&t.request.url&&(t.request.url.indexOf("http://")===0||t.request.url.indexOf("https://")===0)&&t.waitUntil(this.getOptions().then(function(f){return r.getMatchedRule(t.request).then(function(e){if(e){var o=new n.BrowserCache(f.storageName,f.version);i=new n.FetchRequest(t.request,e,o);u=i.getResponse()}u?t.respondWith(u.then(function(n){return n&&i.wasSuccessful()?r.debug("Service worker intercepted the request: ",i):r.debug("Service worker failed to provide a response: ",i),n},function(n){r.debug("Request failed with unexpected error: ",i);throw n;})):r.debug("Request handled by the browser: ",i?i:t.request)})}))},t.prototype.onPush=function(n){if(n.data){var t=n.data.json();t&&n.waitUntil(this.processAction(t))}},t.prototype.onPushSubscriptionChange=function(n){this.debug("Push subscription changed: ",n);n.waitUntil(this.checkPushServiceStatus(!0))},t.prototype.onNotificationClick=function(n){this.debug("Notification clicked: ",n.notification);n.notification.close();n.notification.data&&n.notification.data.url&&n.waitUntil(self.clients.matchAll({type:"window"}).then(function(t){for(var r,i=0;i<t.length;i++)if(r=t[i],r.url===n.notification.data.url&&"focus"in r)return r.focus();return self.clients.openWindow?self.clients.openWindow(n.notification.data.url):!1}))},t.prototype.onSync=function(n){this.debug("Sync request: ",n);n.waitUntil(this.reload())},t.prototype.onMessage=function(t){var i=this;this.debug("New message recieved: ",t);t.waitUntil(this.getOptions().then(function(r){var u=t.data;return u.scope===r.scope?i.processAction(u.data).then(function(i){var f=new n.ResponseMessage(r.scope,u,JSON.parse(JSON.stringify(i)));t.ports[0].postMessage(f)}):Promise.resolve()}))},t.prototype.debug=function(n){for(var i=[],t=1;t<arguments.length;t++)i[t-1]=arguments[t];(!this.cachedOptions||this.cachedOptions.debug)&&console.debug.apply(console,[n].concat(i))},t.prototype.getOptions=function(t){var i=this;return!t&&this.cachedOptions?Promise.resolve(this.cachedOptions):n.BrowserDatabase.loadOptions(self.registration.scope).then(function(t){if(i.cachedOptions=new n.Options(t),!i.cachedOptions)throw new Error("Missing service worker options in IndexedDB.");return i.cachedOptions})},t.prototype.processAction=function(t){if(t.actionType)switch(t.actionType){case n.ActionTypes.Notification:return this.showNotification(t.title,t.options);case n.ActionTypes.ClearCache:return this.getOptions().then(function(i){return new n.BrowserCache(i.storageName,i.version).remove(t.condition)});case n.ActionTypes.Preload:return this.preload(t.urls);case n.ActionTypes.Broadcast:return this.broadcast(t.message);case n.ActionTypes.Reload:return this.reload()}return Promise.resolve(!1)},t.prototype.showNotification=function(n,t){return(this.debug("New notification: ",n,t),!n)?Promise.resolve(!1):self.registration.showNotification(n,t||{}).then(function(){return!0}).catch(function(n){return console.warn("Can not show notification: ",n),!1})},t.prototype.preload=function(t){return this.getOptions().then(function(i){return(t=t||i.preload,!t||t instanceof Array&&t.length===0)?Promise.resolve(!0):((typeof t=="string"||t instanceof String)&&(t=[t]),new n.BrowserCache(i.storageName,i.version).preloadUrls(t))}).catch(function(){return!1})},t.prototype.broadcast=function(t){return(this.debug("Broadcasting message: ",t),!t)?Promise.resolve(!1):this.getOptions().then(function(i){return self.clients.matchAll().then(function(r){if(r.length>0){for(var u=0;u<r.length;u++)r[u].postMessage(new n.Message(i.scope,t));return!0}return!1})})},t.prototype.reload=function(){var t=this;return this.getOptions(!0).then(function(i){return Promise.all([t.preload(),t.checkPersistence(),t.checkPushServiceStatus(!1)]).then(function(){var u,r;for(t.debug("Clear old caches... (< v"+i.version+")"),u=[],r=0;r<i.version;r++)u.push(new n.BrowserCache(i.storageName,r).remove());return Promise.all(u).then(function(){return!0})})}).catch(function(){return!1})},t.prototype.checkPushServiceStatus=function(n){var t=this;return this.getOptions().then(function(i){var r={userVisibleOnly:i.pushUserVisibleOnly,applicationServerKey:i.pushServerKey};return self.registration.pushManager.permissionState(r).then(function(u){return u==="granted"?self.registration.pushManager.getSubscription().then(function(u){(!u||n)&&i.pushServerAddress?self.registration.pushManager.subscribe(r).then(function(n){n?t.reportPushSubscriptionStatus(n).catch(function(){console.warn("Failed to send subscription changes to the server.")}):console.warn("Push service subsription request denied.")}).catch(function(n){console.warn("Failed to subscribe from push service.",n)}):u&&!i.pushServerAddress&&self.registration.pushManager.unsubscribe().then(function(n){n?t.reportPushSubscriptionStatus(null).catch(function(){console.warn("Failed to send subscription changes to the server.")}):console.warn("Push service unsubsription request denied.")}).catch(function(n){console.warn("Failed to unsubscribe from push service.",n)})}).catch(function(n){console.warn("Failed to get push service subscription status.",n)}):Promise.resolve()}).catch(function(n){i.pushServerAddress?console.warn("Push service requests rejected: ",n):t.debug("Push service requests rejected: ",n)})})},t.prototype.reportPushSubscriptionStatus=function(n){return this.getOptions().then(function(t){return new Promise(function(i,r){t.pushServerAddress||r();var u=new XMLHttpRequest;u.onload=function(){u.status===200?i():r()};u.onerror=r;u.onabort=r;u.open("POST",t.pushServerAddress);u.setRequestHeader("Content-Type","application/json;charset=UTF-8");u.send(JSON.stringify(n))})})},t.prototype.checkPersistence=function(){return this.getOptions().then(function(n){return n.persistent&&self.navigator.storage&&self.navigator.storage.persist?self.navigator.storage.persisted().then(function(n){return n||self.navigator.storage.persist().catch(function(){return console.warn("Failed to make storage persistance."),!1}),!0}):Promise.resolve(!n.persistent)})},t.prototype.getMatchedRule=function(n){return this.getOptions().then(function(t){for(var r,i=0;i<t.rules.length;i++)if(r=t.rules[i],r.doesMatch(n))return r;return null})},t.staticConstructor=function(){if(typeof WorkerGlobalScope!="undefined"&&self instanceof WorkerGlobalScope)var n=new t}(),t}()}(AdvancedServiceWorker||(AdvancedServiceWorker={}));